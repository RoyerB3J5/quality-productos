---
// Imports optimizados - solo lo esencial al inicio
import '../styles/global.css';
import 'aos/dist/aos.css';
import Chatbot from '../components/Chatbot.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';

type Translations = typeof import('../i18n/en').default;

export interface Props {
  lang: string;
  t?: Translations;
}

const { lang, t } = Astro.props;
---

<!doctype html>
<html lang={lang} class="overflow-x-hidden scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Crítico: CSS inline para evitar FOUC -->
    <style is:inline>
      body {
        visibility: hidden;
      }
      body.visible {
        visibility: visible;
      }
    </style>
    
    <!-- SEO Local para Orlando -->
		<meta name="geo.region" content="US-FL" />
		<meta name="geo.placename" content="Orlando" />
		<meta name="geo.position" content="28.5383;-81.3792" />
		<meta name="ICBM" content="28.5383, -81.3792" />

    <!-- Preconnect para DNS lookup temprano -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Preconnect para widget de chat - optimización de terceros -->
    <link rel="preconnect" href="https://widgets.leadconnectorhq.com" />
    <link rel="dns-prefetch" href="https://widgets.leadconnectorhq.com" />
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <meta name="generator" content={Astro.generator} />
    <title>Quality Portable Service - Portable Toilet & Rental Solutions You Can Rely On</title>
    <meta
      name="description"
      content="Quality Portable Service provides top-quality portable toilet and rental solutions, ensuring your needs are met with reliability and trust."
    />
    <!-- SEO additions -->
    <meta
      name="keywords"
      content="Portable Toilet, Rental Solutions, Quality Service, Trusted Provider, Portable Restrooms"
    />
    <meta name="author" content="Quality Portable Service" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://qualityportableservice.com/" />
    
    <!-- Alternate language versions -->
		<link rel="alternate" hreflang="en" href="https://qualityportableservice.com/en/" />
		<link rel="alternate" hreflang="es" href="https://qualityportableservice.com/es/" />
		<link rel="alternate" hreflang="x-default" href="https://qualityportableservice.com/en/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Quality Portable Service - Portable Toilet & Rental Solutions You Can Rely On"
    />
    <meta
      property="og:description"
      content="Quality Portable Service provides top-quality portable toilet and rental solutions, ensuring your needs are met with reliability and trust."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://qualityportableservice.com/" />
    <meta property="og:image" content="/images/hero/fondo.png" />
    <meta property="og:locale" content={lang === 'es' ? 'es_US' : 'en_US'} />


    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@QualityPortable" />
    <meta
      name="twitter:title"
      content="Quality Portable Service - Portable Toilet & Rental Solutions You Can Rely On"
    />
    <meta
      name="twitter:description"
      content="Quality Portable Service provides top-quality portable toilet and rental solutions, ensuring your needs are met with reliability and trust."
    />
    <meta name="twitter:image" content="/images/hero/fondo.png" />

    <!-- JSON-LD Organization -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Quality Portable Service",
        "url": "https://qualityportableservice.com/",
        "logo": "https://qualityportableservice.com/favicon.svg"
      }
    </script>
    <script is:inline>
      document.documentElement.classList.toggle(
        'dark',
        localStorage.theme === 'dark' ||
          (!('theme' in localStorage) &&
            window.matchMedia('(prefers-color-scheme: dark)').matches),
      )
    </script>

  </head>
  <body
    class="font-family antialiased overflow-x-hidden bg-[#FFFFFF] flex flex-col justify-center items-center w-full"
  >
    <Header content={t?.header} />
    <main class="flex flex-col w-full items-center">
      <slot />
    </main>
    <Chatbot />
    <Footer content={t?.footer} />

    <script>
      import AOS from 'aos';

      // Función simplificada para inicializar AOS
      function initAOS() {
        try {
          AOS.init({
            duration: 1000,
            once: true,
            offset: 100,
            delay: 100,
            disable: false, // Habilitar en todos los dispositivos
          });
          console.log('AOS inicializado correctamente');
        } catch (error) {
          console.error('Error al inicializar AOS:', error);
        }
      }

      function showContent() {
        document.body.classList.add('visible');
      }

      // Inicialización optimizada pero funcional
      function initializeApp() {
        // Mostrar contenido inmediatamente
        showContent();

        // Inicializar AOS con un pequeño delay
        setTimeout(() => {
          initAOS();
        }, 100);
      }

      // Inicialización según el estado del documento
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }

      // Fallback garantizado para mostrar contenido
      setTimeout(showContent, 500);
    </script>
  </body>
</html>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Observe the visible wrapper elements (form-container) because iframes may be display:none
    const wrappers = Array.from(
      document.querySelectorAll('.form-container')
    ).filter((w) => w.querySelector('iframe[data-src]'));
    const EMBED_SRC = 'https://link.monarcagrooming.com/js/form_embed.js';
    const FALLBACK_MS = 10000; // 10s fallback

    function ensureEmbedScript() {
      if (document.querySelector('script[data-form-embed]')) return;
      const s = document.createElement('script');
      s.src = EMBED_SRC;
      s.async = true;
      s.dataset.formEmbed = 'true';
      document.body.appendChild(s);
    }

    function loadForm(iframe) {
      if (!iframe || iframe.dataset.loaded) return;
      const dataSrc = iframe.dataset && iframe.dataset.src;
      if (!dataSrc) return;

      // Show placeholder if present
      const wrapper = iframe.closest('.form-container') || iframe.parentElement;
      const placeholder = wrapper
        ? wrapper.querySelector('.form-placeholder')
        : null;
      if (placeholder) placeholder.style.display = 'flex';

      // Ensure iframe is not display:none (some browsers delay load when display:none)
      try {
        iframe.style.display = 'block';
      } catch (e) {}

      // Use visibility/opacity to animate in once loaded
      iframe.style.visibility = 'hidden';
      iframe.style.opacity = '0';

      // fallback: if onload doesn't fire, show iframe after timeout
      let fallback = setTimeout(() => {
        if (placeholder) placeholder.style.display = 'none';
        try {
          iframe.style.display = '';
        } catch (e) {}
        iframe.style.visibility = '';
        iframe.style.opacity = '1';
        iframe.dataset.loaded = '1';
      }, FALLBACK_MS);

      iframe.onload = function () {
        clearTimeout(fallback);
        if (placeholder) placeholder.style.display = 'none';
        try {
          iframe.style.display = '';
        } catch (e) {}
        iframe.style.visibility = '';
        iframe.style.opacity = '1';
        iframe.dataset.loaded = '1';
        // adjust height if provided
        const h = iframe.getAttribute('data-height');
        if (h) iframe.style.height = h + 'px';
      };

      // assign src to start loading
      try {
        iframe.src = dataSrc;
      } catch (e) {
        clearTimeout(fallback);
      }

      // Load embed library once the iframe starts loading
      ensureEmbedScript();
    }

    if (wrappers.length === 0) return;

    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const iframe = entry.target.querySelector('iframe[data-src]');
              if (iframe) loadForm(iframe);
              obs.unobserve(entry.target);
            }
          });
        },
        { rootMargin: '200px' }
      );

      wrappers.forEach((w) => io.observe(w));
    } else {
      // Fallback: try load after short delay to avoid blocking initial paint
      setTimeout(() => {
        wrappers.forEach((w) => {
          const iframe = w.querySelector('iframe[data-src]');
          if (iframe) loadForm(iframe);
        });
      }, 300);
    }
  });
</script>

<!-- Consolidated IntersectionObserver for all animations and carousels -->
<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Observer para animaciones: services-header, animation-left, hero-content
    const animationElements = document.querySelectorAll('.services-header, .animation-left, .hero-content, .animation-zoom');
    
    const animationObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
            animationObserver.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.3 }
    );
    
    animationElements.forEach((element) => {
      animationObserver.observe(element);
    });

    // Observer para carousels: .hero-carousel[data-interval]
    const carousels = Array.from(document.querySelectorAll('.hero-carousel[data-interval]'));
    
    if (carousels.length > 0 && 'IntersectionObserver' in window) {
      const carouselObserver = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              // Trigger custom event or initialization if needed
              entry.target.dispatchEvent(new CustomEvent('carouselVisible'));
              obs.unobserve(entry.target);
            }
          });
        },
        { root: null, rootMargin: '400px' }
      );
      
      carousels.forEach((c) => carouselObserver.observe(c));
    }
  });
</script>
