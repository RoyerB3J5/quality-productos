---
import Button from './Button.astro';
import { Icon } from 'astro-icon/components';
import ChangeLanguage from './ChangeLanguage.astro';
import ChangeTheme from './ChangeTheme.astro';

type Translations = typeof import('../i18n/en').default;
type HeaderContent = Translations['header'];
interface Props {
  content?: HeaderContent;
}
const { content } = Astro.props as Props;

// Obtener la ruta actual y normalizar el path sin prefijo de idioma
const currentPath = Astro.url.pathname;
// Normalizar: remover idioma y trailing slash
const normalized =
  currentPath.replace(/^\/(en|es)/, '').replace(/\/$/, '') || '/';
// Detectar el idioma actual ('en' o 'es')
const match = currentPath.match(/^\/(en|es)/);
const lang = match ? match[1] : 'en';
---

<header
  class={`fixed left-0 right-0 z-50 w-full flex flex-col justify-center items-center transition-top duration-300 ease-in-out border-0 top-0`}
  id="site-header"
  style="background-color: rgba(var(--color-primary-rgb), 0); transition: background-color 0.1s ease-out, transform 0.3s ease-out;"
>
  <div
    class={`w-[calc(100%-40px)] xl:w-full sm:max-w-7xl flex justify-between items-center relative  py-3.75 px-5 xl:px-0`}
  >
    <a
        href={`/${lang}`}
        aria-label="Ir a la página principal"
        title="Quality Portable - Inicio"
      >
        <img
          src="/images/logo.svg"
          alt="Logo de Quality Portable"
          width="120"
          height="26"
          class="cursor-pointer w-43.75 h-auto block dark:hidden"
        />
        <img
          src="/images/logo-dark.svg"
          alt="Logo de Quality Portable"
          width="120"
          height="26"
          class="cursor-pointer w-43.75 h-auto hidden dark:block"
        />
      </a>
    <!-- Menú desktop (lg y arriba) -->
    <div
      class="relative bg-transparent flex flex-row justify-start items-center h-auto w-auto z-10 py-0 transform translate-x-0 transition-transform duration-300 ease-out"
    >
      
      <nav
        class="hidden relative lg:flex items-center flex-row justify-center w-auto gap-4 p-2"
      >
        {
          content?.nav.map((item, index) => {
            const itemPathWithoutHash = item.href.split('#')[0];
            const isActive =
              normalized === itemPathWithoutHash ||
              (index === 0 && normalized.startsWith('/locations'));
            const isLocations = index === 0;
            return (
              <div
                class={`flex flex-row items-center justify-center group hover:text-accent w-auto py-2 px-4 text-center ${isLocations ? 'relative dropdown-parent' : ''} ${isActive ? 'bg-transparent ' : ''}`}
                id={`locations-${index}`}
              >
                <a
                  href={`/${lang}${item.href}`}
                  class=" relative transition-colors duration-300 flex justify-center items-center"
                >
                  <p
                    class="text-[16px] font-normal leading-[150%] text-white dark:text-paragraph-dark transition-all duration-300 ease-in-out"
                    set:html={item.label}
                  />
                  <span
                    class={`absolute -bottom-2 left-1/2 h-0.5 bg-accent transition-all duration-300 ease-out -translate-x-1/2 ${isActive ? 'w-8' : 'w-0 group-hover:w-8 group-hover:bg-accent'}`}
                  />
                </a>
                {isLocations && (
                  <div class="dropdown-menu absolute top-9 left-0 mt-0 w-50 flex-col items-center bg-white dark:bg-secondary z-40 hidden group-hover:flex opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-all duration-200 ease-out -translate-x-[20%] shadow-lg overflow-hidden rounded-lg">
                    {content.locations.map((sub) => (
                      <div class="text-[16px] font-medium text-primary-electric dark:text-white py-2 hover:bg-primary hover:text-accent transition-colors duration-200 ease-in-out cursor-pointer px-6 w-full text-center">
                        <a
                          href={`/${lang}/locations/${sub.href}`}
                          class="block w-full h-full"
                        >
                          {sub.label}
                        </a>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })
        }
      </nav>
    </div>
    <div class="flex justify-center items-center gap-6 xl:gap-8">
      <Button
        text={content?.buttons[0].label}
        textClass="text-paragraph"
        href={content?.buttons[0].href}
        target="_blank"
        extraBtnClass={`bg-accent hover:bg-accent/90 hidden lg:flex`}
        iconName={content?.buttons[0].icon}
      />
      <ChangeLanguage />
      <ChangeTheme />
      <div class="flex lg:hidden justify-center items-center gap-7">
        <button
          type="button"
          aria-label="Abrir menú de navegación"
          title="Abrir menú"
          class="flex items-center justify-center cursor-pointer"
          id="hamburger-btn"
        >
          <Icon name={'hamburger'} class={'w-3.5 h-3.5'} aria-hidden="true" />
          <span class="sr-only">Abrir menú de navegación</span>
        </button>
      </div>
    </div>
    <!-- Botones para móvil -->
  </div>
</header>

<!-- Menú móvil independiente (lg para abajo) -->
<div
  class="fixed top-0 right-0 bottom-0 lg:hidden flex items-center bg-primary-intense dark:bg-back-dark text-white dark:text-paragraph-dark flex-col justify-center h-[70%] w-full z-60 py-6 gap-12 transform -translate-y-full transition-transform duration-300 ease-out"
  id="mobile-menu"
>
  <img
    src="/images/equis.svg"
    alt="Cerrar menú"
    width="24"
    height="24"
    class="block absolute top-6 right-6 cursor-pointer z-20"
    id="close-btn"
    aria-label="Cerrar menú de navegación"
    title="Cerrar menú"
    role="button"
    tabindex="0"
  />
  <a
        href={`/${lang}`}
        aria-label="Ir a la página principal"
        title="Quality Portable - Inicio"
      >
        <img
          src="/images/logo.svg"
          alt="Logo de Quality Portable"
          width="120"
          height="26"
          class="cursor-pointer w-36 h-auto block dark:hidden"
        />
        <img
          src="/images/logo-dark.svg"
          alt="Logo de Quality Portable"
          width="120"
          height="26"
          class="cursor-pointer w-30 h-auto hidden dark:block"
        />
      </a>
  <nav class="relative flex items-center flex-col justify-center w-full">
    {
      content?.nav.map((item, index) => {
        const itemPathWithoutHash = item.href.split('#')[0];
        const isActive =
          normalized === itemPathWithoutHash ||
          (index === 0 && normalized.startsWith('/locations'));
        const isLocations = index === 0;
        return (
          <div
            class={`flex flex-col items-center justify-center group gap-3.5 px-0 w-full py-5 text-center text-white dark:text-paragraph-dark ${isLocations ? 'relative' : ''} ${isActive ? 'bg-accent text-white dark:text-paragraph-dark uppercase' : ''}`}
            id={`mobile-locations-${index}`}
          >
            <a
              href={`/${lang}${item.href}`}
              class="relative transition-colors duration-300 flex justify-center items-center "
            >
              <p
                class="text-[18px] font-medium leading-[120%] "
                set:html={item.label}
              />
            </a>
            {isLocations && (
              <div
                class="flex-col justify-center items-center w-full bg-white divide-y divide-secondary hidden absolute z-20 top-0 translate-y-12.5"
                id="sub-menu-locations"
              >
                {content.locations.map((sub) => (
                  <a
                    href={`/${lang}/locations/${sub.href}`}
                    class="text-[16px] font-medium text-primary-electric py-4 transition-colors duration-300 ease-in-out cursor-pointer px-6 w-full text-center"
                  >
                    {sub.label}
                  </a>
                ))}
              </div>
            )}
          </div>
        );
      })
    }
  </nav>

  <div class="flex flex-col justify-center items-center gap-5">
    <Button
        text={content?.buttons[0].label}
        textClass="text-paragraph"
        href={content?.buttons[0].href}
        target="_blank"
        extraBtnClass={`bg-accent `}
        iconName={content?.buttons[0].icon}
      />
  </div>

  <style>
    /* Mejorar el comportamiento del dropdown */
    .dropdown-parent:hover .dropdown-menu {
      display: flex !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Crear un puente invisible entre el botón y el dropdown */
    .dropdown-parent::after {
      content: '';
      position: absolute;
      top: 100%;
      left: -10px;
      right: -10px;
      height: 4px;
      background: transparent;
      z-index: 39;
      pointer-events: auto;
    }

    /* Clase para texto solo visible para lectores de pantalla */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Asegurar que el dropdown se mantenga visible cuando se hace hover */
    .dropdown-menu:hover {
      display: flex !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Hacer que el dropdown mantenga el hover del padre */
    .dropdown-menu {
      margin-top: 0px;
    }

    /* Deshabilitar dropdown y puente en tamaños menores a lg */
    @media (max-width: 1023px) {
      .dropdown-parent::after {
        display: none;
      }

      .dropdown-parent:hover .dropdown-menu {
        display: none !important;
      }

      .dropdown-menu {
        display: none !important;
      }
    }
  </style>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('mobile-menu');
      const openBtn = document.getElementById('hamburger-btn');
      const closeBtn = document.getElementById('close-btn');
      const locationsDiv = document.getElementById('locations-0'); // Desktop locations (locations is index 0)
      const mobileLocationsDiv = document.getElementById('mobile-locations-0'); // Mobile locations (locations is index 0)
      const subMenuLocations = document.getElementById('sub-menu-locations');
      const body = document.body;

      const isMobile = () => window.innerWidth < 1024;

      function openMenu() {
        if (isMobile()) {
          menu.classList.replace('-translate-y-full', 'translate-y-0');
          body.classList.add('overflow-hidden');
        }
      }

      function closeMenu() {
        if (isMobile()) {
          menu.classList.replace('translate-y-0', '-translate-y-full');
          body.classList.remove('overflow-hidden');
        }
      }

      function toggleSubMenu(event) {
        // Solo en móvil prestamos atención al toggle
        if (!isMobile()) return;

        // Seguridad: si no existe el subMenuLocations, no hacemos nada
        if (!subMenuLocations) return;

        const isSubMenuOpen = !subMenuLocations.classList.contains('hidden');

        // Si el submenu está cerrado, prevenimos la navegación y lo abrimos
        if (!isSubMenuOpen) {
          event.preventDefault();
          subMenuLocations.classList.remove('hidden');
          subMenuLocations.classList.add('flex');
        }
        // Si el submenu está abierto y se presiona de nuevo, cerramos el submenu
        // y evitamos la navegación para que el click solo actúe como toggle
        else {
          event.preventDefault();
          subMenuLocations.classList.add('hidden');
          subMenuLocations.classList.remove('flex');
        }
      }

      openBtn.addEventListener('click', openMenu);
      closeBtn.addEventListener('click', closeMenu);

      // Agregar event listener al div padre para que al pulsar el div (no solo el <a>) se active el toggle
      if (locationsDiv) {
        locationsDiv.addEventListener('click', (e) => {
          // Solo actuamos en móvil
          if (!isMobile()) return;
          // Ignorar clicks que vayan dirigidos al propio sub-menu (navegación de items)
          if (e.target.closest('#sub-menu-locations')) return;
          toggleSubMenu(e);
        });
      }

      if (mobileLocationsDiv) {
        mobileLocationsDiv.addEventListener('click', (e) => {
          if (!isMobile()) return;
          if (e.target.closest('#sub-menu-locations')) return;
          toggleSubMenu(e);
        });
      }

      // Asegurar estado inicial según tamaño
      if (isMobile()) {
        menu.classList.add('-translate-y-full');
        menu.classList.remove('translate-y-0');
        body.classList.remove('overflow-hidden');
        if (subMenuLocations) {
          subMenuLocations.classList.add('hidden');
          subMenuLocations.classList.remove('flex');
        }
      } else {
        menu.classList.add('translate-y-0');
        menu.classList.remove('-translate-y-full');
        body.classList.remove('overflow-hidden');
      }

      window.addEventListener('resize', () => {
        if (!isMobile()) {
          menu.classList.add('translate-y-0');
          menu.classList.remove('-translate-y-full');
          body.classList.remove('overflow-hidden');
          // Ocultar submenu en desktop
          if (subMenuLocations) {
            subMenuLocations.classList.add('hidden');
            subMenuLocations.classList.remove('flex');
          }
        } else {
          // Asegura que el menú esté oculto al volver a móvil
          menu.classList.add('-translate-y-full');
          menu.classList.remove('translate-y-0');
          body.classList.remove('overflow-hidden');
          if (subMenuLocations) {
            subMenuLocations.classList.add('hidden');
            subMenuLocations.classList.remove('flex');
          }
        }
      });
      const header = document.getElementById('site-header');
      const viewportHeight = window.innerHeight;
      let lastScroll = window.pageYOffset;

      function updateHeaderBackground() {
        const currentScroll = window.pageYOffset;
        const isDark = document.documentElement.classList.contains('dark');
        const colorVar = isDark ? '--color-back-dark-rgb' : '--color-primary-rgb';
        
        // Calcular la opacidad: 0 al inicio, 1 cuando se alcance 50vh
        const opacity = Math.min(currentScroll / (viewportHeight * 0.5), 1);
        
        // Actualizar el fondo del header con la opacidad calculada
        header.style.backgroundColor = `rgba(var(${colorVar}), ${opacity})`;
      }

      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        
        updateHeaderBackground();

        // Mostrar/ocultar header según dirección del scroll, pero SOLO después de los primeros 100vh
        if (currentScroll > viewportHeight) {
          if (currentScroll > lastScroll && currentScroll > 100) {
            // Scroll hacia abajo: escondemos el header
            header.style.transform = 'translateY(-120%)';
          } else {
            // Scroll hacia arriba: mostramos el header
            header.style.transform = 'translateY(0)';
          }
        } else {
          // Dentro de los primeros 100vh, siempre mostrado
          header.style.transform = 'translateY(0)';
        }

        lastScroll = currentScroll;
      });

      // Observer para detectar cambios en el tema (clase 'dark')
      const observer = new MutationObserver(() => {
        updateHeaderBackground();
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class'],
      });
    });
  </script>
</div>
