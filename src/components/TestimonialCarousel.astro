---
type Translations = typeof import('../i18n/en').default;
type TestimonialsItemsContent = Translations['locations']['orlando-fl']['testimonials']['items'];
interface Props {
  content: TestimonialsItemsContent;
}
const { content } = Astro.props as Props;
---

<style>
  .carousel-track {
    gap: 24px;
  }
  
  .carousel-item {
    flex: 0 0 auto;
  }

  .carousel-container {
    overflow: hidden;
  }

  .carousel-viewport {
    overflow: hidden;
  }
</style>

<div class="carousel-viewport relative w-full max-w-184.25 animation-left">
  <div class="h-[25%] w-full shadow-testimony absolute top-0 right-0 z-10"></div>
  <div class="h-[25%] w-full shadow-testimony absolute bottom-0 right-0 z-10 rotate-180"></div>
  <div class="carousel-container flex justify-center items-center w-full">
    <div class="carousel-track flex flex-col justify-center items-center w-full max-w-184.25">
      {/* Triplicar items para loop infinito sin saltos */}
      {content.map((item) => (
        <div class="carousel-item flex flex-col justify-center items-center rounded-2xl bg-back gap-4 py-22.5 w-full">
          <div class="flex flex-col justify-center items-start gap-4">
            <div class="flex justify-center items-center gap-4">
              <img src={`/images/${item.image}.svg`} alt={item.name} width="80" height="80" decoding="async" loading="lazy" class="w-24 h-auto"/>
              <div class="flex flex-col justify-center items-start gap-1.75">
                <p class="text-primary text-center text-[18px] font-bold leading-[155%]">{item.name}</p>
                <p class="text-[14px] font-normal leading-[155%] text-[#808080]">{item.time}</p>
                <div class="flex justify-center items-center gap-2">
                  {
                    Array.from({ length: 5 }).map((_, index) => (
                      <img src="/images/star.svg" alt="Estrella de calificación" width="20" height="20" decoding="async" loading="lazy" class="inline-block w-8 h-auto" />
                    ))
                  }
                </div>
              </div>
            </div>
            <p class="text-paragraph text-start text-[18px] font-normal leading-[155%] max-w-90.75">{item.description}</p>
          </div>
        </div>
      ))}
      {content.map((item) => (
        <div class="carousel-item flex flex-col justify-center items-center rounded-2xl bg-back gap-4 py-22.5 w-full">
          <div class="flex flex-col justify-center items-start gap-4">
            <div class="flex justify-center items-center gap-4">
              <img src={`/images/${item.image}.svg`} alt={item.name} width="80" height="80" decoding="async" loading="lazy" class="w-24 h-auto"/>
              <div class="flex flex-col justify-center items-start gap-1.75">
                <p class="text-primary text-center text-[18px] font-bold leading-[155%]">{item.name}</p>
                <p class="text-[14px] font-normal leading-[155%] text-[#808080]">{item.time}</p>
                <div class="flex justify-center items-center gap-2">
                  {
                    Array.from({ length: 5 }).map((_, index) => (
                      <img src="/images/star.svg" alt="Estrella de calificación" width="20" height="20" decoding="async" loading="lazy" class="inline-block w-8 h-auto" />
                    ))
                  }
                </div>
              </div>
            </div>
            <p class="text-paragraph text-start text-[18px] font-normal leading-[155%] max-w-90.75">{item.description}</p>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const track = document.querySelector('.carousel-track');
  const viewport = document.querySelector('.carousel-viewport');

  if (!track || !viewport) return;

  let anim = null;
  const speedPxPerSec = 50;
  const visibleItems = 3;

  function startAnim() {
    if (anim) anim.cancel();

    const items = Array.from(track.querySelectorAll('.carousel-item'));
    if (items.length < 2) return;

    const originalCount = items.length / 2;
    if (!originalCount) return;

    const firstItem = items[0];
    const itemHeight = firstItem.offsetHeight;

    const trackStyle = getComputedStyle(track);
    const gap = parseFloat(trackStyle.gap || '0') || 0;

    const viewportHeight =
      itemHeight * visibleItems +
      gap * (visibleItems - 1);

    viewport.style.height = `${viewportHeight}px`;

    let totalHeight = 0;
    for (let i = 0; i < originalCount; i++) {
      totalHeight += items[i].offsetHeight;
    }
    totalHeight += gap * (originalCount - 1);

    const duration = Math.max(
      4000,
      (totalHeight / speedPxPerSec) * 1000
    );

    anim = track.animate(
      [
        { transform: 'translateY(0)' },
        { transform: `translateY(-${totalHeight}px)` }
      ],
      {
        duration,
        iterations: Infinity,
        easing: 'linear'
      }
    );

    if (viewport.dataset.hoverBound !== '1') {
      viewport.addEventListener('mouseenter', () => anim?.pause());
      viewport.addEventListener('mouseleave', () => anim?.play());
      viewport.dataset.hoverBound = '1';
    }
  }

  startAnim();

  window.addEventListener('resize', () => {
    if (anim) anim.cancel();
    startAnim();
  });
});
</script>
