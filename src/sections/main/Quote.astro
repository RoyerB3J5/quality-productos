---
import Button from '../../components/Button.astro';

type Translations = typeof import('../../i18n/en').default;
type FormContent = Translations['main']['form'];
interface Props {
  content: FormContent;
}
const { content } = Astro.props as Props;
---
<section class="w-full flex justify-center items-center relative" id="quote-section">
  <img src="/images/back-form.webp" alt="Imagen de Fondo Quality Port" width="1500" height="1144" decoding="async" loading="lazy" class="absolute top-0 left-0 w-full h-full object-cover object-[50%_80%] inset-0 z-0"/>
  <div class="w-full h-full z-5 bg-black/40 absolute"></div>
  <div class="w-full max-w-screen xl:max-w-7xl px-5 xl:px-0 flex justify-between items-start gap-18.75 py-30 z-10 relative" data-quote-section>
    <div class="w-[40%] flex flex-col justify-center items-start gap-4 transform" data-quote-content>
      <div class="flex justify-start items-center gap-2 services-header" >
        <div class="w-2 h-2 bg-white dark:bg-paragraph-dark"></div>
        <p class="text-white dark:text-paragraph-dark text-[16px] font-normal leading-[150%] uppercase">
            {content.subtitle}
        </p>
      </div>
      <div class="flex flex-col justify-center items-start gap-10 services-header">
        <h2 class="text-white dark:text-paragraph-dark text-[56px] font-semibold leading-[114%]">{content.title}</h2>
        <p class="text-white dark:text-paragraph-dark text-[16px] font-normal leading-[150%]">{content.description}</p>
        <Button
              text={content.buttons[0].label}
              textClass={'text-paragraph'}
              href={content.buttons[0].href}
              target="_blank"
              extraBtnClass={'bg-accent hover:bg-accent/90'}
              iconName={content.buttons[0].icon}
            />
      </div>
    </div>
    <div class="w-[60%] aspect-737/860 h-auto rounded-2xl bg-primary-electric animation-left" >
    </div>
  </div>
</section>

<script is:inline>
{
  function initQuoteAnimation() {
    const quotesSections = document.querySelectorAll('[data-quote-section]');
    
    quotesSections.forEach((parent) => {
      const content = parent.querySelector('[data-quote-content]');
      if (!content) return;

      let maxTranslate = 0;
      let animationFrameId = null;
      let contentStartTop = 0;
      let lastScrollTop = window.scrollY || document.documentElement.scrollTop;

      const offsetDown = 24;
      const offsetUp = 100;

      function calculateMaxTranslate() {
        const parentHeight = parent.offsetHeight;
        const contentHeight = content.offsetHeight;

        const styles = getComputedStyle(parent);
        const paddingTop = parseFloat(styles.paddingTop) || 0;
        const paddingBottom = parseFloat(styles.paddingBottom) || 0;
        const verticalPadding = paddingTop + paddingBottom;

        maxTranslate = Math.max(0, parentHeight - verticalPadding - contentHeight);

        contentStartTop = content.getBoundingClientRect().top + (window.scrollY || document.documentElement.scrollTop);
      }

      function updateTransform() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const isScrollingDown = scrollTop > lastScrollTop;
        lastScrollTop = scrollTop;

        const currentOffset = isScrollingDown ? offsetDown : offsetUp;
        let translateAmount = 0;

        if (scrollTop >= contentStartTop - currentOffset) {
          const scrollProgress = scrollTop - (contentStartTop - currentOffset);
          translateAmount = Math.min(scrollProgress, maxTranslate);
        }

        content.style.transform = `translateY(${translateAmount}px)`;
      }

      function onScroll() {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        animationFrameId = requestAnimationFrame(updateTransform);
      }

      // Iniciar parallax después de que las animaciones CSS se ejecuten (700ms = 600ms del fadeRight + margen)
      setTimeout(() => {
        calculateMaxTranslate();
        updateTransform();
        window.addEventListener('scroll', onScroll, { passive: true, capture: false });
        window.addEventListener('resize', () => {
          calculateMaxTranslate();
          updateTransform();
        });
      }, 700);
    });
  }

  // Ejecutar cuando el DOM esté completamente listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQuoteAnimation);
  } else {
    initQuoteAnimation();
  }
}
</script>
